import pandas as pd
import numpy as np

# =================================================
# 1Ô∏è‚É£ Chargement du dataset
# =================================================
data = pd.read_excel(r"C:\Users\ajana\OneDrive\Desktop\dataset_irrigation_final_version_1.xlsx")

# =================================================
# 2Ô∏è‚É£ S√©paration X / Y
# =================================================
X = data[[
    "Temp√©rature (¬∞C)",
    "Humidit√©Sol (%)",
    "TempsDepuisIrrigation (h)",
    "pH",
    "Luminosit√© (lux)"
]].values.astype(float)

Y = data["VolumeEau (cl)"].values.reshape(-1, 1).astype(float)

# =================================================
# 3Ô∏è‚É£ NORMALISATION Min‚ÄìMax S√âCURIS√âE
# =================================================
X_min = X.min(axis=0)
X_max = X.max(axis=0)

Y_min = Y.min()
Y_max = Y.max()

# √©viter division par z√©ro
X_range = X_max - X_min
X_range[X_range == 0] = 1

Y_range = Y_max - Y_min
if Y_range == 0:
    Y_range = 1

0\\0X_norm = (X - X_min) / X_range
Y_norm = (Y - Y_min) / Y_range

# =================================================
# 4Ô∏è‚É£ Ajout du biais (b)
# =================================================
X_norm = np.hstack((np.ones((X_norm.shape[0], 1)), X_norm))

# =================================================
# 5Ô∏è‚É£ R√âGRESSION MANUELLE OPTIMIS√âE
# (pseudo-inverse ‚Üí plus stable que inv)
# =================================================
theta = np.linalg.pinv(X_norm) @ Y_norm

# =================================================
# 6Ô∏è‚É£ Pr√©dictions
# =================================================
Y_pred_norm = X_norm @ theta
Y_pred = Y_pred_norm * Y_range + Y_min

# =================================================
# 7Ô∏è‚É£ M√âTRIQUES
# =================================================
mse = np.mean((Y - Y_pred) ** 2)

ss_tot = np.sum((Y - Y.mean()) ** 2)
ss_res = np.sum((Y - Y_pred) ** 2)
r2 = 1 - (ss_res / ss_tot)

print("\n‚úÖ COEFFICIENTS DU MOD√àLE :")
print("b =", theta[0][0])
print("a_Temp =", theta[1][0])
print("a_HumSol =", theta[2][0])
print("a_Temps =", theta[3][0])
print("a_pH =", theta[4][0])
print("a_Lum =", theta[5][0])

print("\nüìâ MSE =", mse)
print("üìà R¬≤ =", r2)

# =================================================
# 8Ô∏è‚É£ Pr√©diction d‚Äôun nouveau point
# =================================================
temperature = 27.5
humidite_sol = 58
temps_depuis_irrigation = 0
ph = 6.7
luminosite = 500

X_new = np.array([[temperature, humidite_sol, temps_depuis_irrigation, ph, luminosite]])

X_new_norm = (X_new - X_min) / X_range
X_new_norm = np.hstack((np.ones((1,1)), X_new_norm))

Y_new_norm = X_new_norm @ theta
Y_new = Y_new_norm * Y_range + Y_min

print("\nüåä Volume d'eau pr√©dit =", float(Y_new[0][0]), "cl")

# =================================================
# 9Ô∏è‚É£ Sauvegarde du mod√®le
# =================================================
np.save("theta.npy", theta)
np.save("Xmin.npy", X_min)
np.save("Xmax.npy", X_max)
np.save("Ymin.npy", Y_min)
np.save("Ymax.npy", Y_max)